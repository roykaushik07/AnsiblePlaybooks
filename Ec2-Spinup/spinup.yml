---
- hosts: localhost
  gather_facts: true
  
  vars:
    instance_type: t2.micro
    group_id: sg-f726a090
    image: ami-b0ac25c3
    #count: 1
    keypair: kaushik-dev-2016
    region: eu-west-1

  tasks:
  - name: Launch EC2 instance
    ec2:
       group_id={{ group_id }}
       instance_type={{ instance_type }} 
       image={{ image }}
       wait=true
       keypair={{ keypair }}
       count={{ count }}
       region={{ region }}
    register: ec2
    
  - name: Add all instance public IPs to host group
    add_host: hostname={{ item.public_ip }} groups=ec2hosts
    with_items: ec2.instances
    
  - name: Wait for SSH to come up
    local_action: wait_for host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
    with_items: ec2.instances
       